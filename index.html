<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Spending Tracker Calendar</title>

  <!-- PWA manifest -->
  <link rel="manifest" href="manifest.json">
  <meta name="theme-color" content="#16161a">

   <!-- iOS PWA support -->
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Spending Tracker">
  <link rel="apple-touch-icon" href="icon-192.png">

  <style>
    :root {
      --bg: #0b0b0d;
      --card: #16161a;
      --accent: #9b5de5;
      --gold: #fbbf24;
      --red: #ef4444;
      --white: #f9fafb;
      --muted: #9ca3af;
    }
    * { box-sizing: border-box; }
    body {
      margin: 0;
      font-family: 'Inter', system-ui, sans-serif;
      background: radial-gradient(circle at top left, #1c1b22, var(--bg));
      color: var(--white);
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 2rem;
    }
    header {
      max-width: 900px;
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
    }
    h1 { font-size: 1.4rem; font-weight: 600; }
    button {
      background: var(--accent);
      color: var(--white);
      border: none;
      border-radius: 10px;
      padding: 0.5rem 1rem;
      cursor: pointer;
      font-weight: 500;
      transition: all 0.2s;
    }
    button:hover { opacity: 0.9; transform: translateY(-1px); }
    .danger { background: var(--red); }
    .calendar {
      max-width: 900px;
      width: 100%;
      background: var(--card);
      padding: 1rem;
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.3);
    }
    .month-row { display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem; }
    .grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 6px; }
    .weekday { text-align: center; color: var(--muted); font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; }
    .day { position: relative; background: rgba(255,255,255,0.04); border-radius: 10px; min-height: 90px; padding: 8px; cursor: pointer; transition: all 0.2s; }
    .day:hover { background: rgba(255,255,255,0.08); transform: scale(1.03); }
    .day.out { opacity: 0.25; }
    .date { font-weight: 600; }
    .total { position: absolute; bottom: 8px; right: 8px; padding: 4px 6px; border-radius: 8px; font-size: 0.75rem; color: #fff; background: var(--accent); }
    .today { outline: 2px solid var(--gold); }
    .muted { color: var(--muted); font-size: 0.85rem; }
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.6); display: flex; align-items: center; justify-content: center; z-index: 50; }
    .modal { background: var(--card); border-radius: 16px; padding: 1.5rem; width: 100%; max-width: 500px; box-shadow: 0 0 30px rgba(0,0,0,0.4); animation: fadeIn 0.2s ease; }
    @keyframes fadeIn { from{opacity:0; transform:scale(0.95);} to{opacity:1; transform:scale(1);} }
    .entry-color { width: 24px; height: 24px; border-radius: 50%; border: 1px solid rgba(255,255,255,0.3); margin-right: 8px; }
    input, select, input[type=color] { background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.08); color: var(--white); padding: 8px; border-radius: 8px; width: 100%; font-size: 0.9rem; }
    table { width: 100%; border-collapse: collapse; }
    th, td { padding: 6px; border-bottom: 1px solid rgba(255,255,255,0.05); }
  </style>
</head>
<body>
  <header>
    <h1>ðŸ’° Spending Tracker Calendar</h1>
    <div>
      <button id="exportBtn">Export</button>
      <button id="importBtn">Import</button>
      <input type="file" id="importFile" accept="application/json" style="display:none" />
      <button id="clearBtn" class="danger">Clear All</button>
    </div>
  </header>

  <div class="calendar">
    <div class="month-row">
      <div>
        <button id="prev">â—€</button>
        <span id="monthYear" style="margin:0 10px;font-weight:600"></span>
        <button id="next">â–¶</button>
      </div>
      <button id="todayBtn">Today</button>
    </div>

    <div class="grid" id="weekdays">
      <div class="weekday">Sun</div><div class="weekday">Mon</div><div class="weekday">Tue</div>
      <div class="weekday">Wed</div><div class="weekday">Thu</div><div class="weekday">Fri</div><div class="weekday">Sat</div>
    </div>

    <div class="grid" id="daysGrid" style="margin-top:8px"></div>
  </div>

  <div id="modalRoot" style="display:none"></div>

  <script>
    if('serviceWorker' in navigator){
      navigator.serviceWorker.register('service-worker.js').then(()=>console.log('SW registered')); 
    }

    const STORAGE_KEY = 'spendingCalendar_pwa';
    const loadData = ()=> JSON.parse(localStorage.getItem(STORAGE_KEY)||'{}');
    const saveData = d=> localStorage.setItem(STORAGE_KEY, JSON.stringify(d));

    let data = loadData();
    let viewDate = new Date(); viewDate.setDate(1);

    const daysGrid = document.getElementById('daysGrid');
    const monthYearEl = document.getElementById('monthYear');

    const money = n => 'Â£' + Number(n||0).toFixed(2);
    const fmt = d=> d.toISOString().split('T')[0];

    function render(){
      daysGrid.innerHTML='';
      const y=viewDate.getFullYear(), m=viewDate.getMonth();
      monthYearEl.textContent=viewDate.toLocaleString(undefined,{month:'long',year:'numeric'});
      const first=new Date(y,m,1).getDay();
      const daysIn=new Date(y,m+1,0).getDate();
      const start=new Date(y,m,1-first);
      const totalCells=Math.ceil((first+daysIn)/7)*7;
      for(let i=0;i<totalCells;i++){
        const d=new Date(start);d.setDate(start.getDate()+i);
        const key=fmt(d);
        const cell=document.createElement('div');
        cell.className='day'+(d.getMonth()==m?'':' out')+(fmt(d)==fmt(new Date())?' today':'');
        cell.innerHTML=`<div class="date">${d.getDate()}</div>`;
        if(data[key]){
          const total=data[key].reduce((s,x)=>s+Number(x.amount),0);
          const color=data[key].slice(-1)[0].color||'var(--accent)';
          const badge=document.createElement('div');
          badge.className='total';
          badge.style.background=color;
          badge.textContent=money(total);
          cell.appendChild(badge);
        }
        cell.onclick=()=>openDay(key);
        daysGrid.appendChild(cell);
      }
    }

    function openDay(dateKey){
      const modalRoot=document.getElementById('modalRoot');
      modalRoot.style.display='block'; modalRoot.innerHTML='';
      const backdrop=document.createElement('div');backdrop.className='modal-backdrop';
      const modal=document.createElement('div');modal.className='modal';
      modal.innerHTML=`<h2>${new Date(dateKey).toDateString()}</h2>`;
      const items=data[dateKey]||[];
      let table='<table><thead><tr><th></th><th>Description</th><th>Cat</th><th>Amount</th><th></th></tr></thead><tbody>';
      for(const it of items){
        table+=`<tr><td><div class='entry-color' style='background:${it.color||'var(--accent)'}'></div></td><td>${escape(it.description)}</td><td class='muted'>${escape(it.category)}</td><td>${money(it.amount)}</td><td><button data-id='${it.id}' class='del danger'>âœ•</button></td></tr>`;
      }
      table+='</tbody></table>';
      modal.innerHTML+=table;
      modal.innerHTML+=`<div style='margin-top:10px;display:grid;gap:6px;'>
        <input id='desc' placeholder='Description'>
        <input id='cat' placeholder='Category'>
        <input id='amt' placeholder='Amount'>
        <label style='display:flex;align-items:center;gap:8px;'>Color <input id='col' type='color' value='#9b5de5' style='width:40px;height:30px;border:none;border-radius:6px;'></label>
        <button id='add'>Add Spending</button>
      </div>`;
      const close=document.createElement('button');close.textContent='Close';close.style.marginTop='10px';close.onclick=()=>{modalRoot.style.display='none';render();};
      modal.appendChild(close);
      backdrop.appendChild(modal);modalRoot.appendChild(backdrop);

      modal.querySelector('#add').onclick=()=>{
        const desc=modal.querySelector('#desc').value.trim();
        const cat=modal.querySelector('#cat').value.trim();
        const amt=parseFloat(modal.querySelector('#amt').value);
        const col=modal.querySelector('#col').value;
        if(!desc||isNaN(amt)) return alert('Enter valid description and amount');
        if(!data[dateKey]) data[dateKey]=[];
        data[dateKey].push({id:Date.now()+Math.random(),description:desc,category:cat,amount:amt,color:col});
        saveData(data);openDay(dateKey);
      };
      modal.querySelectorAll('.del').forEach(btn=>btn.onclick=()=>{
        const id=btn.dataset.id;data[dateKey]=data[dateKey].filter(x=>x.id!=id);if(!data[dateKey].length)delete data[dateKey];saveData(data);openDay(dateKey);
      });
    }

    const escape=s=>s.replace(/[&<>"']/g,c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;','\'':'&#39;'}[c]));

    document.getElementById('prev').onclick=()=>{viewDate.setMonth(viewDate.getMonth()-1);render();};
    document.getElementById('next').onclick=()=>{viewDate.setMonth(viewDate.getMonth()+1);render();};
    document.getElementById('todayBtn').onclick=()=>{viewDate=new Date();viewDate.setDate(1);render();};
    document.getElementById('clearBtn').onclick=()=>{if(confirm('Clear all data?')){data={};saveData(data);render();}};
    document.getElementById('exportBtn').onclick=()=>{
      const blob=new Blob([JSON.stringify(data,null,2)],{type:'application/json'});
      const a=document.createElement('a');a.href=URL.createObjectURL(blob);a.download='spending.json';a.click();
    };
    document.getElementById('importBtn').onclick=()=>document.getElementById('importFile').click();
    document.getElementById('importFile').onchange=e=>{
      const f=e.target.files[0];if(!f)return;const r=new FileReader();r.onload=()=>{try{data=JSON.parse(r.result);saveData(data);render();}catch{alert('Invalid JSON');}};r.readAsText(f);
    };

    render();
  </script>
</body>
</html>
